---
title: "Bayacao Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: column
    vertical_layout: fill
    theme: 
      version: 3
      bootswatch: united
runtime: shiny
---

```{r setup, include=FALSE}
# ------------------- Chargement des bibliothèques -------------------
pacman::p_load(
  leaflet,
  plotly,
  shiny,
  shinydashboard,
  readxl,
  flexdashboard,
  sf,
  dplyr,
  lubridate,
  tidyr,
  scales,
  DT,
  shinyWidgets,
  purrr,
  rio,
  here,
  geosphere,
  reshape2,
  ggrepel
)

# ------------------- Lecture des Données Excel -------------------
# Utiliser here() pour définir le chemin vers le fichier Excel
file_path <- here("datasets","Las horas de laborales","Processed_Historial.xlsx")

# Lire toutes les feuilles du fichier Excel dans une liste
sheets <- excel_sheets(file_path)  # Obtenir les noms des feuilles

# Lire toutes les feuilles dans une liste
sheets_data <- lapply(sheets, function(sheet_name) {
  import(file_path, which = sheet_name)
})

names(sheets_data) <- sheets

df_compra <- import(here("datasets","Compra","compra_filtra.xlsx"))
df_productores <- import(here("datasets","Compra", "desempeno_del_productor.xlsx"))
df_meteo <- import(here("datasets","meteo","datos_meteo.xlsx"))

# ------------------- Lecture du Fichier KML -------------------
kml_file <- here("kml","doc.kml")
df_kml <- st_read(kml_file)

# ------------------- Lecture des Fichiers Shapefile -------------------
# Lire le shapefile de la carte de la République Dominicaine (niveau administratif 1)
carte_Dom <- st_read(here("dom_shp", "dom_admbnda_adm1_one_20210629.shp"), options = "IGNORE_ERRORS=YES") %>%
  st_transform(crs = 4326)  # Transformer en CRS WGS 84

# Lire le shapefile de la carte de la République Dominicaine (niveau administratif 3)
carte_Dom2 <- st_read(here("dom_shp", "dom_admbnda_adm3_one_20210629.shp"), options = "IGNORE_ERRORS=YES") %>%
  st_transform(crs = 4326)  # Transformer en CRS WGS 84

# Palette de couleurs personnalisée
custom_colors <- c("#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2","#25A385","#661AEE","#B0E0E6")

```

# Map of Driver Locations {data-orientation="rows"}

## Sidebar {.sidebar}

```{r}
# ------------------- Sélecteur de Feuille -------------------
# Utiliser selectizeInput pour choisir la feuille
selectizeInput(
  inputId = "ID001",
  label = "Choose a sheet :",
  choices = sheets,
  selected = sheets[1]
)

# ------------------- Données Réactives -------------------
# Créer une fonction réactive pour obtenir les données de la feuille sélectionnée
df_hora_trabajadas <- reactive({
  sheet_name <- input$ID001
  if (is.null(sheet_name) || !(sheet_name %in% names(sheets_data))) {
    return(NULL)  # Retourner NULL si la feuille n'est pas valide
  }
  sheets_data[[sheet_name]]
})

# ------------------- Sélecteurs de Dates -------------------
# Utiliser dateRangeInput pour sélectionner une période
dateRangeInput(
  inputId = "ID002",
  label = "Select a period :",
  start = Sys.Date() - 1,  # Valeur par défaut, ajuster selon vos besoins
  end = Sys.Date(),
  startview = "month",
  language = "es",
  separator = " à ",
  format = "dd/mm/yyyy"
)

# ------------------- Mise à Jour des Inputs de Date -------------------
# Observer les changements dans les données et mettre à jour les inputs de date
observe({
  data <- df_hora_trabajadas()
  
  if (is.null(data) || nrow(data) == 0 || all(is.na(data$Tiempo))) {
    # Ne rien faire si les données sont NULL, vides ou toutes les valeurs sont NA
    return()
  }
  
  # Mettre à jour les inputs de date avec les valeurs min et max des données
  min_date <- min(as.Date(data$Tiempo,format = "%Y-%m-%d"), na.rm = TRUE)
  max_date <- max(as.Date(data$Tiempo,format = "%Y-%m-%d"), na.rm = TRUE) + 1
  
  # Calculer la date de fin pour les trois premiers jours
  start_date <- max_date - 1
  end_date <- max_date 
  
  updateDateRangeInput(session, "ID002",
                       min = min_date,
                       max = max_date,
                       start = start_date,
                       end = end_date)
})


```

## Map of Dominican Republic

```{r}
# Fonction pour calculer les distances entre les points
calculate_distances <- function(data) {
  coords <- data %>% select(longitude, latitude)
  dists <- distHaversine(coords[-nrow(coords), ], coords[-1, ])
  return(dists)
}

# Fonction pour segmenter les routes
segment_routes <- function(data, threshold) {
  dists <- calculate_distances(data)
  segments <- cumsum(c(0, dists > threshold))
  data$segment <- segments
  return(data)
}

output$map1 <- renderLeaflet({
  
  data <- df_hora_trabajadas()
  if (is.null(data)) {
    return(NULL)
  }
  
  date_range <- input$ID002
  if (is.null(date_range) || length(date_range) != 2) {
    return(data)
  }
  
  start_date <- as.Date(date_range[1], format = "%Y-%m-%d")
  end_date <- as.Date(date_range[2], format = "%Y-%m-%d")

  if (is.null(data)) return(NULL)
  threshold_distance <- 3000  # Seuil de distance en mètres pour segmenter les routes
  df_filtered <- data %>%
      filter(!is.na(longitude), !is.na(latitude)) %>%  # Supprimer les points NA
      filter(longitude != 0, latitude != 0) %>%        # Supprimer les points aberrants
      segment_routes(threshold_distance)
  
  # Filtrer les points d'arrêt
  stops <- df_filtered %>%
    filter(is_stop == TRUE) %>%
    group_by(group) %>%
    summarise(latitude = first(latitude),
              longitude = first(longitude),
              label = first(local_name))
  
  df_filtered_today <- df_filtered %>%
    filter(Tiempo >= start_date & Tiempo <= end_date)

  if (!is.null(df_filtered) && nrow(df_filtered) > 0) {

    mymap <- leaflet() %>%
      addTiles()
      
    # Ajouter les routes en polylines bleues
    mymap <- mymap %>%
      addPolygons(data = carte_Dom, color = "black", weight = 1, fillOpacity = 0.2)
    
    for (segment_id in unique(df_filtered$segment)) {
      segment_data <- df_filtered %>% filter(segment == segment_id)
      mymap <- mymap %>%
        addPolylines(
          data = segment_data,
          lng = ~longitude,
          lat = ~latitude,
          color = "blue",
          weight = 2,
          group = "Routes"
        ) 
    }

    # Ajouter les points d'arrêt en orange
    mymap <- mymap %>%
      addCircleMarkers(data = stops,
                      color = "orange",
                      lng = ~longitude,
                      lat = ~latitude,
                      radius = 6,
                      label = ~paste(label),
                      group = "Stops")
    
    # Ajouter les producteurs en rouge
    mymap <- mymap %>%
      addMarkers(data = df_kml,
                 icon = icons(
                   iconUrl = "https://cdn-icons-png.flaticon.com/512/684/684908.png",
                   iconWidth = 15, iconHeight = 15,
                   iconAnchorX = 15, iconAnchorY = 30
                 ),
                 label = ~paste(Name),
                 group = "Producers")
    
    # Calculer le centre géographique du premier segment pour centrer la carte
    red_segment_data <- df_filtered %>% filter(segment == unique(df_filtered$segment)[1])  # Prenez le premier segment pour l'exemple
    center_lon <- mean(red_segment_data$longitude, na.rm = TRUE)
    center_lat <- mean(red_segment_data$latitude, na.rm = TRUE)
    
    # Définir la vue initiale pour centrer sur le segment
    mymap <- mymap %>%
      setView(lng = center_lon, lat = center_lat, zoom = 10)
    
    # Ajouter les marqueurs de vitesse pour les segments filtrés
    mymap <- mymap %>%
      addCircleMarkers(
        data = df_filtered_today,
        lng = ~longitude,
        lat = ~latitude,
        color = ~colorNumeric(palette = "YlOrRd", domain = df_filtered_today$speed)(speed),
        radius = ~sqrt(speed) / 4,  # Taille des marqueurs en fonction de la vitesse
        popup = ~paste("Speed:", speed, "kph"),
        fillOpacity = 0.7,
        group = "Speed"
      ) %>%
      addLegend(
        position = "bottomright",
        pal = colorNumeric(palette = "YlOrRd", domain = df_filtered_today$speed),
        values = df_filtered_today$speed,
        title = "Speed (kph)",
        opacity = 1,
        group = "Speed"
      )
    
    # Ajouter des légendes pour chaque type de données
    mymap <- mymap %>%
      addLegend(
        title = "Legend :",
        position = "bottomleft",
        colors = c("blue","orange","red"),
        labels = c("Routes","Stops","Producers"),
        opacity = 0.5,
        group = c("Routes","Stops","Producers")
      )
    
    # Ajouter un contrôle des couches pour activer/désactiver les couches
    mymap <- mymap %>%
      addLayersControl(
        overlayGroups = c("Routes", "Stops", "Producers", "Speed"),
        options = layersControlOptions(collapsed = FALSE)
      )
    
    # Afficher la carte
    mymap
  } else {
    leaflet() %>%
      addTiles() %>%
      addPolygons(data = carte_Dom, color = "black", weight = 1, fillOpacity = 0.2)
  }
})

div(class = "map", leafletOutput("map1", height = "100vh"))

```

## Données Clés

### 

```{r}
output$valueBox6 <- renderUI({
  data <- df_hora_trabajadas()
  
  value <- paste0(round(sum(data$distance),2)," KM")
  
  div(
    class = "custom-container",
    div(
      h4("Total Distance over the Last 15 Days"),
      h2(value)
    )
  )
})


div(class = "fixed-height-box", uiOutput("valueBox6"))
```

### 

```{r}
output$valueBox7 <- renderUI({
  data <- df_hora_trabajadas()
  start_date <- as.Date(input$ID002[1], format = "%Y-%m-%d")
  end_date <- as.Date(input$ID002[2], format = "%Y-%m-%d")
  data <- data %>%
    filter(Tiempo >= start_date & Tiempo <= end_date + 1)
  
  value <- paste0(round(sum(data$distance),2)," KM")
  
  div(
    class = "custom-container2",
    div(
      h4("Total Distance in the Selected Time Range"),
      h2(value)
    )
  )
})


div(class = "fixed-height-box",uiOutput("valueBox7"))
```

### 

```{r}
output$valueBox8 <- renderUI({
  data <- df_hora_trabajadas()
  data <- data %>%
    filter(is_stop == FALSE)
  
  total_seconds <- sum(data$time_diff)
  
  # Convert total_seconds to a period
  period <- seconds_to_period(total_seconds)
  
  # Extract days, hours, minutes, and seconds from the period
  days <- floor(total_seconds / (24 * 3600))
  hours <- floor((total_seconds %% (24 * 3600)) / 3600)
  minutes <- floor((total_seconds %% 3600) / 60)
  seconds <- total_seconds %% 60

  # Format the string
  value <- paste0(days, " day(s) ",hours,":",minutes,":",seconds)
  
  
  div(
    class = "custom-container",
    div(
      h4("Time Spent Traveling within the Selected Area"),
      h2(value)
    )
  )
})

div(class = "fixed-height-box", uiOutput("valueBox8"))
```

# Depending on the day {data-navmenu="Value Visualization Calendar" data-navmenu-icon="fa-bookmark"}

## Sidebar {.sidebar}

```{r}
choice_year <- unique(year(df_compra$Fecha))

# ------------------- Sélecteur d'année -------------------
selectizeInput(
  inputId = "ID101",
  label = "Choose a year :",
  choices = choice_year,
  selected = year(Sys.Date())
)

# ------------------- Sélecteur d'Acheteur -------------------
# Liste des acheteurs uniques triés
unique_compradores <- sort(unique(df_compra$Comprador))

# Utiliser pickerInput pour sélectionner un ou plusieurs acheteurs
pickerInput(
  inputId = "ID102",
  label = "Choose One or All Buyers :",
  choices = unique_compradores,
  selected = unique_compradores,
  multiple = TRUE,
  options = list(
    `actions-box` = TRUE,  # Permet de sélectionner/désélectionner tout
    `selected-text-format` = "count > 3",  # Affiche un nombre si plus de 3 éléments sélectionnés
    `live-search` = TRUE  # Ajoute une fonction de recherche en direct
  )
)

df_calender_compradores <- reactive({
  df <- df_compra %>% filter(Comprador %in% input$ID102 & year(Fecha) == input$ID101)
  df
})

```

## Column 

### 

```{r}

output$calendarHeatmap <- renderPlot({
  # Compléter les dates et créer les variables nécessaires
  df <- df_calender_compradores() %>%
    complete(Fecha = seq(min(Fecha), max(Fecha), by = "day")) %>%
    mutate(
      week = week(Fecha),
      weekday = weekdays(Fecha),
      day = day(Fecha),
      month = factor(month(Fecha), levels = 1:12, labels = month.name),
      year = year(Fecha),
      weekday_num = factor(weekday, levels = c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")),
      month_num = as.integer(month(Fecha))
    )
  
  # Ajuster les semaines pour les mois de décembre et janvier
  df <- df %>%
    mutate(
      week = case_when(
        month == "December" & week == 1 ~ 53,
        month == "January" & week %in% 52:53 ~ 0,
        TRUE ~ week
      )
    )
  

  # Définir les niveaux de légende
  levels_de <- c(
    "< -80",
    "-80;-50",
    "-50;-20",
    "-20;0",
    "0;20",
    "20;80",
    "> 80"
  )
  
  # Créer des catégories pour delta_kg basées sur les quantiles avec des labels descriptifs
  df <- df %>%
    mutate(
      de = cut(delta_kg, breaks = c(-Inf, -80, -50, -20, 0, 20, 80, +Inf), include.lowest = TRUE,
               labels = levels_de)
    )

  # Créer une palette de couleurs avec suffisamment de couleurs
  col_p <- colorRampPalette(c("#FF0000", "#FF6F6F", "#FF9A9A", "#ECCCA2", "#D0F0FB", "#B0D6F5", "#00A3E0"))
  
  # Créer le Calendar Heatmap
  ggplot(df, aes(weekday_num, -week, fill = de)) +
    geom_tile(colour = "white", size = 0.4) +
    geom_text(aes(label = day), colour = "black", size = 2.5) +
    scale_fill_manual(values = col_p(length(levels_de)), breaks = levels_de, labels = levels_de, na.value = "white") +
    facet_wrap(~month, nrow = 4, ncol = 3, scales = "free") +
    labs(
      title = "Activity Calendar Heatmap",
      subtitle = "Delta Activity by Day",
      caption = "Data Source: Bayacao",
      fill = "Delta kg"
    ) +
    theme_minimal() +
    theme(
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      axis.text.x = element_text(size = 8, angle = 45, hjust = 1),
      axis.text.y = element_text(size = 8),
      strip.text = element_text(size = 12, face = "bold", color = "white"),
      legend.position = "bottom",
      legend.box = "horizontal",
      legend.title = element_text(size = 12, face = "bold"),
      legend.text = element_text(size = 10),
      panel.grid = element_blank(),
      panel.border = element_rect(color = "white", fill = NA, linewidth = 0.5),
      panel.spacing = unit(1, "lines"),
      strip.background = element_rect(fill = "#772953", color = "white"),
      plot.title = element_text(size = 20, face = "bold"),
      plot.subtitle = element_text(size = 14),
      plot.caption = element_text(size = 10)
    )

  
})

plotOutput("calendarHeatmap")
```

# View by Buyers {data-navmenu="Value Visualization Calendar"}

## Sidebar {.sidebar}

```{r}
# ------------------- Sélecteur d'année -------------------
# Charger les données pour les choix d'année et de mois
choice_data <- df_compra %>%
  mutate(YearMonth = paste(year(Fecha), month.name[month(Fecha)], sep = " - ")) %>%
  distinct(YearMonth) %>%
  pull(YearMonth)

# Créer le sélecteur combiné
selectizeInput(
  inputId = "ID104",
  label = "Choose Year and Month:",
  choices = choice_data,
  selected = paste(year(Sys.Date()), month.name[month(Sys.Date())], sep = " - ")
)

# Filtrer les données en fonction de l'année et du mois sélectionnés
df_calendar_month <- reactive({
  # Extraire l'année et le mois sélectionnés
  selected_year_month <- input$ID104
  selected_year <- as.numeric(str_extract(selected_year_month, "^\\d{4}"))
  selected_month <- str_extract(selected_year_month, "[A-Za-z]+$")
  
  # Filtrer le dataframe en fonction de l'année et du mois
  df_compra %>%
    filter(year(Fecha) == selected_year, month.name[month(Fecha)] == selected_month)
})

```

## Column

```{r}

output$calendarHeatmap3 <- renderPlot({
  # Compléter les dates pour le mois sélectionné et créer les variables nécessaires
  df <- df_calendar_month() %>%
    group_by(Comprador) %>% 
    complete(
      Fecha = seq(
        as.Date(paste(year(min(Fecha)), month(min(Fecha)), "01", sep = "-")),
        as.Date(paste(year(max(Fecha)), month(max(Fecha)), days_in_month(max(Fecha)), sep = "-")),
        by = "day"
      )
    ) %>%
    ungroup() %>%
    mutate(
      week = week(Fecha),
      weekday_num = factor(weekdays(Fecha), levels = c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday")),
      day = day(Fecha),
      month = factor(month(Fecha), levels = 1:12, labels = month.name),
      year = year(Fecha)
    ) %>%
    mutate(
      week = case_when(
        month == "December" & week == 1 ~ 53,
        month == "January" & week %in% 52:53 ~ 0,
        TRUE ~ week
      ),
      de = cut(delta_kg, breaks = c(-Inf, -80, -50, -20, 0, 20, 80, Inf), include.lowest = TRUE,
               labels = c("< -80", "-80;-50", "-50;-20", "-20;0", "0;20", "20;80", "> 80"))
    )
  
  # Créer une palette de couleurs avec suffisamment de couleurs
  col_p <- colorRampPalette(c("#FF0000", "#FF6F6F", "#FF9A9A", "#ECCCA2", "#D0F0FB", "#B0D6F5", "#00A3E0"))
  
  # Définir les couleurs pour chaque break
  colors <- col_p(7)  # Crée une palette de 7 couleurs
  color_mapping <- setNames(colors, c("< -80", "-80;-50", "-50;-20", "-20;0", "0;20", "20;80", "> 80"))
  
  # Créer le Calendar Heatmap
  ggplot(df, aes(weekday_num, -week, fill = de)) +
    geom_tile(color = "white", size = 0.4) +
    geom_text(aes(label = day), color = "black", size = 2.5) +
    scale_fill_manual(values = color_mapping, na.value = "white") +
    facet_wrap(~Comprador, nrow = 4, ncol = 3, scales = "free") +
    labs(
      title = "Activity Calendar Heatmap",
      subtitle = "Delta Activity by Day",
      caption = "Data Source: Bayacao",
      fill = "Delta kg"
    ) +
    theme_minimal() +
    theme(
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      axis.text.x = element_text(size = 8, angle = 45, hjust = 1),
      axis.text.y = element_text(size = 8),
      strip.text = element_text(size = 12, face = "bold", color = "white"),
      legend.position = "bottom",
      legend.box = "horizontal",
      legend.title = element_text(size = 12, face = "bold"),
      legend.text = element_text(size = 10),
      panel.grid = element_blank(),
      panel.border = element_rect(color = "white", fill = NA, linewidth = 0.5),
      panel.spacing = unit(1, "lines"),
      strip.background = element_rect(fill = "#772953", color = "white"),
      plot.title = element_text(size = 20, face = "bold"),
      plot.subtitle = element_text(size = 14),
      plot.caption = element_text(size = 10)
    )
})

plotOutput("calendarHeatmap3", height = "100vh")
```

# Wind and Precipitation {data-navmenu="Meteo Data" data-navmenu-icon="fa-bookmark"}

## Sidebar {.sidebar}

```{r}
choice_year <- unique(year(df_compra$Fecha))

# ------------------- Sélecteur d'année -------------------
selectizeInput(
  inputId = "ID105",
  label = "Choose a year :",
  choices = choice_year,
  selected = year(Sys.Date())
)

#------------------- Sélecteur de Time Range -------------------

radioGroupButtons(
  inputId = "ID106",
  label = "Select a Range Time :",
  choices = c("All the year" = "1", "The most recent 6 months" = "2" ,
              "The most recent 3 months" = "3","The last 30 days" = "4"),
  selected = "1",
  direction = "vertical"
)


df_calendar_meteo <- reactive({
  df <- df_meteo %>% filter(year(date) == input$ID105)
  if (!is.null(input$ID106)) {
    if (input$ID106 == "1"){
      return(df) 
    } else if (input$ID106 == "2"){
      df <- df %>% filter(month(date) >= max(month(df$date))-6)
      return(df)
    } else if (input$ID106 == "3"){
      df <- df %>% filter(month(date) >= max(month(df$date))-3)
      return(df)
    } else {
      # Date maximale dans le dataframe
      date_max <- max(as.Date(df$date)) - 29
      
      # Filtrer le dataframe pour obtenir les données des 30 derniers jours
      df <- df %>%
        filter(date > date_max)
      return(df)
    }
  }
  df
})

```

## Column 

###

```{r}
output$meteo3 <- renderPlot({
  df <- df_calendar_meteo() %>%
    select(date, prcp) %>%
    mutate(
      date = as.Date(date),
      prcp = replace_na(prcp, 0))
  
  
  ggplot(df, aes(x = date, y = prcp)) +
    geom_bar(stat = "identity", aes(fill = prcp), color = "black", width = 0.7) +
    geom_text(aes(label = ifelse(prcp > 25, as.character(prcp), "")), vjust = -0.3, size = 3.5, color = "black") +
    labs(
      title = "Daily Pluviometer in Monte Plata",
      x = "Date",
      y = "Pluviometer (mm)"
    ) +
    scale_x_date(date_labels = "%d-%b-%Y", date_breaks = "2 week") +  # Format des dates
    theme_minimal(base_size = 14) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
      axis.title = element_text(size = 14, face = "bold"),
      plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      legend.position = "none"  # Supprimer la légende pour la couleur de remplissage
    )
})

plotOutput("meteo3")
```

### 

```{r}
output$meteo1 <- renderPlot({
  # Graphique combiné pour la vitesse du vent et les rafales
  df <- df_calendar_meteo() %>%
    select(date,wind,gust)
  df <- na.omit(df)
  
  ggplot(df, aes(x = date)) +
    geom_line(aes(y = wind, color = "Wind Speed (km/h)"), size = 1) +
    geom_line(aes(y = gust, color = "Gusts (km/h)"), size = 1) +
    labs(title = "Wind Speed and Gusts",
         x = "Date",
         y = "Wind Speed (km/h)",
         color = "Legend") +
    theme_minimal()

})


plotOutput("meteo1", height = "50vh")

```

## Column {data-orientation="rows"}

### Rose des Vents {data-height=1000}

```{r}
output$meteo2 <- renderPlot({
  df <- df_calendar_meteo() %>%
    select(date,dir_wind,wind)
  
  df <- na.omit(df)
  
  # Regrouper les données par direction du vent
  df_wind <- df %>%
    mutate(
      dir_bin = cut(dir_wind, breaks = seq(0, 360, by = 10), include.lowest = TRUE),
      dir_bin_label = as.numeric(sub("\\((.+),.*", "\\1", dir_bin)) + 5  # Extraire le début de l'intervalle et ajouter 5 pour centrer
    ) %>%
    group_by(dir_bin_label) %>%
    summarise(
      freq = n(),                # Compter le nombre d'observations par tranche
      wind_avg = mean(wind)      # Calculer la vitesse moyenne du vent par tranche
    ) %>%
    ungroup()
  
  # Créer une rose des vents plus esthétique avec ggplot2
  ggplot(df_wind, aes(x = dir_bin_label, y = freq, fill = wind_avg)) +
    geom_bar(stat = "identity", width = 10, color = "black") +
    coord_polar(start = -pi/18) +
    scale_x_continuous(
      breaks = seq(0, 360, by = 30),
      labels = paste0(seq(0, 360, by = 30), "°"),
      limits = c(0, 360)
    ) +
    scale_fill_gradientn(
      colors = c("#56B1F7", "#3366FF", "#2A52BE", "#000080"),
      name = "Vitesse du vent\n(km/h)",
      guide = guide_colorbar(barwidth = 10, barheight = 0.5, title.position = "top")
    ) +
    theme_minimal() +
    theme(
      panel.grid.major = element_line(color = "gray70", linetype = "dotted"),
      panel.grid.minor = element_blank(),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      axis.text.x = element_text(size = 12, face = "bold"),
      axis.text.y = element_blank(),
      legend.position = "bottom",
      plot.title = element_text(hjust = 0.5, size = 16, face = "bold")
    ) +
    labs(
      title = "Rose des Vents"
    )
})

plotOutput("meteo2", height = "50vh")
```

### Données 

####

```{r}
output$valueBox12 <- renderUI({
  data <- df_calendar_meteo()
  
  value <- paste0(round(sum(data$prcp, na.rm = T),2)," mm")
  
  div(
    class = "custom-container",
    div(
      h4("Total Precipitation"),
      h2(value)
    )
  )
})


uiOutput("valueBox12")
```

####

```{r}
output$valueBox13 <- renderUI({
  data <- df_calendar_meteo()
  
  value <- paste0(round(mean(data$dir_wind, na.rm = T),2),"ø")
  
  div(
    class = "custom-container2",
    div(
      h4("Wind Direction"),
      h2(value)
    )
  )
})


uiOutput("valueBox13")
```

# The temperature level {data-navmenu="Meteo Data"} 

## Column {data-width=1200}

###

```{r}
output$meteo4 <- renderPlotly({
  # Transformer les données
  df_long <- melt(df_calendar_meteo(), id.vars = "date", measure.vars = c("temp", "rs", "hr"),
                  variable.name = "variable", value.name = "value")
  
  p <- ggplot(df_long, aes(x = date, y = value, color = variable, linetype = variable)) +
    geom_line(size = 1) +
    facet_grid(variable ~ ., scales = "free_y") +
    scale_color_manual(values = c(
      "temp" = "#0056d6",   # Bleu clair
      "rs" = "#ff6a13",    # Orange clair
      "hr" = "#4aa06c")) + # Vert clair
    scale_linetype_manual(values = c(
      "temp" = "solid",
      "rs" = "solid",
      "hr" = "solid")) + # Types de lignes pour chaque variable
    labs(
      title = "Température, Rayonnement Solaire et Taux d'Humidité",
      x = "Date",
      y = "Valeur",
      color = "Variables",
      linetype = "Variables"
    ) +
    theme_minimal(base_size = 14, base_family = "Palatino") +
    theme(
      strip.text = element_text(size = 14, face = "bold"),
      axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
      axis.title = element_text(size = 12, face = "bold"),
      plot.title = element_text(size = 16, face = "bold"),
      legend.title = element_text(size = 12),
      legend.text = element_text(size = 10),
      panel.grid.major = element_line(color = "#F4E6E0"),
      panel.grid.minor = element_line(color = "#F4E6E0"),
      legend.position = "none"
    ) 
    
  
  # Convertir le graphique en interactif avec plotly
  ggplotly(p)
})


plotlyOutput("meteo4")
```

## Column

###

```{r}
output$valueBox9 <- renderUI({
  data <- df_calendar_meteo()
  
  value <- paste0(round(mean(data$temp, na.rm = T),2)," °C")
  
  div(
    class = "custom-container",
    div(
      h4("Average temperature"),
      h2(value)
    )
  )
})


uiOutput("valueBox9")
```

###

```{r}
output$valueBox10 <- renderUI({
  data <- df_calendar_meteo()
  
  value <- paste0(round(mean(data$rs, na.rm = T),2)," W/m²")
  
  div(
    class = "custom-container2",
    div(
      h4("Average Solar Radiation"),
      h2(value)
    )
  )
})


uiOutput("valueBox10")
```

###

```{r}
output$valueBox11 <- renderUI({
  data <- df_calendar_meteo()
  
  value <- paste0(round(mean(data$hr, na.rm = T),2)," %")
  
  div(
    class = "custom-container",
    div(
      h4("Average rate humidity"),
      h2(value)
    )
  )
})


uiOutput("valueBox11")
```

# Based on a Duration {data-navmenu="Purchase variation" data-navmenu-icon="fa-bookmark"}

## Sidebar {.sidebar}

```{r}
# ------------------- Sélecteur de Date -------------------
# Utiliser dateRangeInput pour sélectionner un intervalle de dates
dateRangeInput(
  inputId = "ID003",
  label = "Select Date Range :",
  start = max(df_compra$Fecha, na.rm = TRUE) - days(7),
  end = max(df_compra$Fecha, na.rm = TRUE),
  min = min(df_compra$Fecha, na.rm = TRUE),
  max = max(df_compra$Fecha, na.rm = TRUE),
  format = "yyyy-mm-dd",
  startview = "month",
  language = "es",
  separator = " a "
)

# ------------------- Sélecteur de Condition -------------------
# Utiliser checkboxGroupButtons pour sélectionner les conditions
checkboxGroupButtons(
  inputId = "ID004",
  label = "Condition :",
  choices = c("Baba" = "baba", "Seco" = "seco", "Fermentado" = "fermentado"),
  selected = c("baba"),
  direction = "vertical"
)

# ------------------- Filtrage des Données -------------------
# Fonction réactive pour filtrer les données en fonction de la période et des conditions
filtered_df <- reactive({
  start_date <- as.Date(input$ID003[1], format = "%Y-%m-%d")
  end_date <- as.Date(input$ID003[2], format = "%Y-%m-%d")
  
  df_compra %>%
    filter(Fecha >= start_date & Fecha <= end_date & Condicion %in% input$ID004)
})

# ------------------- Agrégation des Données -------------------
# Fonction réactive pour agréger les données filtrées
df_filtered <- reactive({
  filtered_df() %>%
    group_by(Comprador, Condicion) %>%
    summarise(
      total_kg_pagado = sum(total_kg_pagado, na.rm = TRUE),
      total_kg_Bruto = sum(total_kg_Bruto, na.rm = TRUE)
    ) %>%
    pivot_longer(cols = c(total_kg_pagado, total_kg_Bruto),
                 names_to = "Type",
                 values_to = "kg") %>%
    mutate(Type = factor(Type, levels = c("total_kg_pagado", "total_kg_Bruto"), labels = c("Purchase", "Handle in the factory")))
})

# ------------------- Calcul des Variations -------------------
# Fonction réactive pour calculer les variations des données filtrées
variations_df <- reactive({
  # Calculer le total pour chaque 'Comprador'
  summary_df <- filtered_df() %>%
    group_by(Comprador) %>%
    summarise(total_achat = sum(total_kg_pagado, na.rm = TRUE),
              total_brut = sum(total_kg_Bruto, na.rm = TRUE)) %>%
    ungroup()
  
  # Ajouter la proportion et trier les résultats
  summary_df <- summary_df %>%
    mutate(total_proporcion_delta = (total_brut - total_achat)/total_brut) %>%
    arrange(desc(total_proporcion_delta))
  
  return(summary_df)
})

# ------------------- Filtrage et Agrégation Supplémentaires -------------------
# Fonction réactive pour filtrer et agréger les données avec delta
variations2_df <- reactive({
  filtered_df() %>%
    group_by(Comprador, Condicion) %>%
    summarise(delta_kg = sum(delta_kg, na.rm = TRUE)) %>%
    ungroup() %>%
    group_by(Comprador) %>%
    summarise(total_delta_kg = sum(delta_kg, na.rm = TRUE)) %>%
    ungroup() %>%
    arrange(desc(total_delta_kg))
})

```

## Column {data-width="550"}

### 

```{r}
output$barplot1 <- renderPlot({

  ggplot(df_filtered(), aes(x = Comprador, y = kg, fill = Type, group = Type)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.8) +
    geom_line(aes(group = Comprador), position = position_dodge(0.4)) +
    geom_text(aes(label = scales::comma(kg)),
              position = position_dodge(width = 0.8),
              vjust = -0.5,
              size = 3) +
    labs(
      title = "Quantity of kg Purchased vs. Transferred to the Factory",
      x = "Buyers",
      y = "Quantity of kg",
      fill = "Type of kg"
    ) +
    theme_minimal(base_size = 15) +
    theme(
      plot.title = element_text(hjust = 0.5),
      axis.title.x = element_text(margin = margin(t = 10)),
      axis.title.y = element_text(margin = margin(r = 10)),
      axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
      strip.background = element_rect(fill = "lightgrey", color = "black"),
      strip.text = element_text(size = 14, face = "bold")
    ) +
    facet_wrap(~ Condicion, scales = "free_y")
})

plotOutput("barplot1", height = "50vh")

```

## Column {data-width="450"}

### 

```{r}
output$rankingPlot1 <- renderPlot({
  ggplot(variations_df(), aes(x = reorder(Comprador, -total_proporcion_delta), y = total_proporcion_delta, fill = total_proporcion_delta)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = paste0(round(total_proporcion_delta, 2), " %")),
              vjust = -0.5,
              size = 3) +
    labs(
      title = "Ranking of Buyers by Total Variation in %",
      x = "Buyers",
      y = "total Variation (%)",
      fill = "total Variation (%)"
    ) +
    scale_fill_gradient2(
      low = "#e73e01",   # Couleur pour les valeurs négatives

      high = "#048B9A",  # Couleur pour les valeurs positives
      midpoint = 0       # Point de transition entre les deux couleurs
    ) +
    theme_minimal(base_size = 15) +
    theme(
      plot.title = element_text(hjust = 0.5),
      axis.title.x = element_text(margin = margin(t = 10)),
      axis.title.y = element_text(margin = margin(r = 10)),
      axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
      strip.background = element_rect(fill = "lightgrey", color = "black"),
      strip.text = element_text(size = 14, face = "bold")
    )
})

plotOutput("rankingPlot1", height = "50vh")

```

### 

```{r}
output$rankingPlot2 <- renderPlot({
  ggplot(variations2_df(), aes(x = reorder(Comprador, -total_delta_kg), y = total_delta_kg, fill = total_delta_kg)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = paste0(round(total_delta_kg, 2), " kg")),
              vjust = -0.5,
              size = 3) +
    labs(
      title = "Ranking of Buyers by Total Variation in kg",
      x = "Buyers",
      y = "total Variation (kg)",
      fill = "total Variation (kg)"
    ) +
    scale_fill_gradient2(
      low = "#e73e01",   # Couleur pour les valeurs négatives

      high = "#048B9A",  # Couleur pour les valeurs positives
      midpoint = 0       # Point de transition entre les deux couleurs
    ) +
    theme_minimal(base_size = 15) +
    theme(
      plot.title = element_text(hjust = 0.5),
      axis.title.x = element_text(margin = margin(t = 10)),
      axis.title.y = element_text(margin = margin(r = 10)),
      axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
      strip.background = element_rect(fill = "lightgrey", color = "black"),
      strip.text = element_text(size = 14, face = "bold")
    )
})

plotOutput("rankingPlot2", height = "50vh")
```

# A View of Purchases by Buyers {data-navmenu="Purchase variation" data-orientation="rows"}

## Sidebar {.sidebar}

```{r}
# ------------------- Sélecteur de Condition -------------------
# Utiliser radioGroupButtons pour sélectionner une condition
radioGroupButtons(
  inputId = "ID005",
  label = "Condition :",
  choices = c("Baba" = "baba", "Seco" = "seco", "Fermentado" = "fermentado"),
  selected = "baba"
)

# ------------------- Sélecteur d'Acheteur -------------------
# Liste des acheteurs uniques triés
unique_compradores <- sort(unique(df_compra$Comprador))

# Utiliser pickerInput pour sélectionner un ou plusieurs acheteurs
pickerInput(
  inputId = "ID006",
  label = "Choose One or All Buyers :",
  choices = unique_compradores,
  selected = unique_compradores,
  multiple = TRUE,
  options = list(
    `actions-box` = TRUE,  # Permet de sélectionner/désélectionner tout
    `selected-text-format` = "count > 3",  # Affiche un nombre si plus de 3 éléments sélectionnés
    `live-search` = TRUE  # Ajoute une fonction de recherche en direct
  )
)

# ------------------- Filtrage des Données -------------------

df_compra_filtered <- reactive({
  df_compra %>% filter(Comprador %in% input$ID006 & Condicion == input$ID005)
})


```

## Column {data-height="1300"}

### 

```{r}
output$boxplot1 <- renderPlotly({
  df_compra_filter <- df_compra_filtered()

  fig <- plot_ly(
    data = df_compra_filter,
    y = ~delta_kg,
    x = ~Comprador,
    type = "box",
    color = ~Comprador,  # Utiliser color pour les couleurs de remplissage
    colors = custom_colors,  # Appliquer la palette de couleurs
    quartilemethod = "linear",
    boxpoints = "all",
    jitter = 0.3,
    pointpos = -1.8,
    marker = list(
      outliercolor = "red",
      size = 5
    ),
    line = list(
      width = 0.5
    )
  ) %>%
    layout(
      title = list(
        text = "Distribution of the Difference in kg (Purchased vs. Delivered to the Factory) by Buyer",
        x = 0.5
      ),
      xaxis = list(
        title = "Buyers",
        tickangle = 45,
        tickfont = list(size = 10),
        titlefont = list(size = 12)
      ),
      yaxis = list(
        title = "Delta Kg",
        titlefont = list(size = 12)
      ),
      legend = list(
        title = list(text = "Buyers"),
        font = list(size = 10)
      ),
      margin = list(t = 50)
    )
  
  fig
})

plotlyOutput("boxplot1", height = "90vh")

```

## Column

### 

```{r}
output$valueBox1 <- renderUI({
  df_compra_filter <- df_compra_filtered()
  value = dollar(mean(df_compra_filter$total_kg_Bruto/df_compra_filter$cantidad_saco))
  div(
    class ="custom-container",
    div(
      h4("The Average Price per Kilogram of a Purchased Bag"),
      h2(value)
    )
  )
})


uiOutput("valueBox1")
```

### 

```{r}
output$valueBox2 <- renderUI({
  df_compra_filter <- df_compra_filtered()
  value = nrow(df_compra_filter)
  div(
    class ="custom-container2",
    div(
      h4("Number of Purchases per Day and per Buyer"),
      h2(value)
    )
  )
})

uiOutput("valueBox2")
```

### 

```{r}
output$valueBox3 <- renderUI({
  df_compra_filter <- df_compra_filtered()

  value = paste(sum(df_compra_filter$delta_kg)," KG")
  div(
    class ="custom-container",
    div(
      h4("Total Weight Discrepancies between Purchase and Reception at the Factory"),
      h2(value)
    )
  )
})

uiOutput("valueBox3")
```

### 

```{r}
output$valueBox4 <- renderUI({
  df_compra_filter <- df_compra_filtered()
  somme_poids <- sum(df_compra_filter$total_kg_pagado, na.rm =T)
  moyenne_ponderee <- sum(df_compra_filter$delta_kg * df_compra_filter$total_kg_pagado)/somme_poids
  
  value = paste(round(moyenne_ponderee ,2)," KG")
  div(
    class ="custom-container2",
    div(
      h4("Average Weight Variations"),
      h2(value)
    )
  )
})

uiOutput("valueBox4")
```

### 

```{r}
output$valueBox5 <- renderUI({
  df_compra_filter <- df_compra_filtered()

  value = paste(round(sum(df_compra_filter$total_kg_Bruto))," KG")
  div(
    class ="custom-container",
    div(
      h4("Number of KG Purchased (Gross Arrived at the Factory)"),
      h2(value)
    )
  )
})

uiOutput("valueBox5")
```

# Weekly Purchase Overview by Buyer {data-navmenu="Purchase variation" data-orientation="rows"}

## Sidebar {.sidebar}

```{r}
# ------------------- Sélecteur de Condition -------------------
# Radio buttons pour choisir la condition
radioGroupButtons(
  inputId = "ID007",
  label = "Condition :",
  choices = c("Baba" = "baba", "Seco" = "seco", "Fermentado" = "fermentado"),
  selected = "baba"
)

# ------------------- Sélecteur de Acheteurs -------------------
# Liste des acheteurs uniques
unique_compradores <- sort(unique(df_compra$Comprador))

pickerInput(
  inputId = "ID008",
  label = "Choose Buyers :",
  choices = unique_compradores,
  selected = unique_compradores,  # Sélectionne tous les acheteurs par défaut
  multiple = TRUE,
  options = list(
    `actions-box` = TRUE,
    `selected-text-format` = "count > 3",  # Affiche un nombre si plus de 3 éléments sélectionnés
    `live-search` = TRUE  # Ajoute une fonction de recherche en direct
  )
)

# ------------------- Sélecteur de Période -------------------
dateRangeInput(
  inputId = "ID009",
  label = "Sélectionner une période :",
  start = min(df_compra$Fecha),
  end = max(df_compra$Fecha),
  min = min(df_compra$Fecha),
  max = max(df_compra$Fecha),
  format = "dd/mm/yyyy",
  separator = " à "
)

# ------------------- Sélecteur d'Intervalle d'Affichage -------------------
selectInput(
  inputId = "ID010",
  label = "Display data by :",
  choices = c("Days", "Weeks"),
  selected = "Weeks"
)

# ------------------- Données Filtrées -------------------
# Réactive pour filtrer les données en fonction de la condition et des acheteurs sélectionnés
df_compra_filtered2 <- reactive({
  df <- df_compra %>% 
    filter(Condicion == input$ID007)
  
  if (!is.null(input$ID009)) {
    df <- df %>% 
      filter(Fecha >= input$ID009[1] & Fecha <= input$ID009[2])
  }
  
  return(df %>% filter(Comprador %in% input$ID008))
})

# ------------------- Données Longues -------------------
data_long <- reactive({
  df <- df_compra_filtered2()
  
  if (input$ID010 == "Days") {
    df %>%
      pivot_longer(cols = c("total_kg_pagado", "total_kg_Bruto"), names_to = "Type", values_to = "Kg") %>%
      mutate(
        Date = as.Date(Fecha, format = "%A-%d-%m")
      ) %>%
      group_by(Date, Type) %>%
      summarise(Kg = sum(Kg), .groups = 'drop')
  } else {
    df %>%
      pivot_longer(cols = c("total_kg_pagado", "total_kg_Bruto"), names_to = "Type", values_to = "Kg") %>%
      mutate(
        Week = format(as.Date(Fecha, format = "%Y-%m-%d"), "%Y-%U"),
        Week_Start_Date = as.Date(paste0(Week, "-1"), "%Y-%U-%u")
      ) %>%
      group_by(Week, Week_Start_Date, Type) %>%
      summarise(Kg = sum(Kg), .groups = 'drop')
  }
})

# ------------------- Tableau Résumé -------------------
summary_table_dt <- reactive({
  df_filtered <- df_compra_filtered2()

  # Ajouter les colonnes pour le mois et le numéro de la semaine
  df_filtered <- df_filtered %>%
    mutate(
      Month = format(Fecha, "%B"),
      Month = factor(Month, levels = month.name)  # Utiliser les niveaux de mois pour le tri correct
    )

  # Filtrer les données en fonction du choix de l'utilisateur (jours ou semaines)
  if (input$ID010 == "Days") {
    df_filtered <- df_filtered %>%
      mutate(Date = as.Date(Fecha)) %>%
      group_by(Date) %>%
      summarise(
        Sum_total_kg_Bruto = sum(total_kg_Bruto, na.rm = TRUE),
        Sum_delta_kg = sum(delta_kg, na.rm = TRUE),
        Month = first(Month),
        .groups = 'drop'
      ) %>%
      arrange(desc(Date))
  } else {
    df_filtered <- df_filtered %>%
      mutate(Week = isoweek(Fecha)) %>%
      group_by(Week) %>%
      summarise(
        Sum_total_kg_Bruto = sum(total_kg_Bruto, na.rm = TRUE),
        Sum_delta_kg = sum(delta_kg, na.rm = TRUE),
        Month = first(Month),
        .groups = 'drop'
      ) %>%
      arrange(desc(Week))
  }

  # Calculer les sommes cumulées
  summary_table <- df_filtered %>%
    arrange(if (input$ID010 == "Days") Date else Week) %>%
    mutate(
      Cumulative_Sum_total_kg_Bruto = cumsum(Sum_total_kg_Bruto),
      Cumulative_Sum_delta_kg = cumsum(Sum_delta_kg),
      Variation_difference = (Cumulative_Sum_delta_kg - lag(Cumulative_Sum_delta_kg)) / abs(lag(Cumulative_Sum_delta_kg)) * 100,
      Variation_kg = Cumulative_Sum_delta_kg - lag(Cumulative_Sum_delta_kg)
    ) %>%
    arrange(desc(if (input$ID010 == "Days") Date else Week)) %>%
    mutate(
      Cumulative_Sum_total_kg_Bruto = replace_na(Cumulative_Sum_total_kg_Bruto, 0),
      Cumulative_Sum_delta_kg = replace_na(Cumulative_Sum_delta_kg, 0),
      Variation_difference = replace_na(Variation_difference, 0),
      Variation_kg = replace_na(Variation_kg, 0)
    ) %>%
    mutate(
      Cumulative_Sum_total_kg_Bruto = paste0(Cumulative_Sum_total_kg_Bruto, " kg"),
      Cumulative_Sum_delta_kg = paste0(Cumulative_Sum_delta_kg, " kg"),
      Variation_difference = paste0(round(Variation_difference, 2), " %"),
      Variation_kg = paste0(round(Variation_kg, 2), " kg")
    )

  # Sélection des colonnes en fonction de l'intervalle choisi
  if (input$ID010 == "Days") {
    summary_table <- summary_table %>%
      select(Date, Sum_total_kg_Bruto, Cumulative_Sum_total_kg_Bruto, Cumulative_Sum_delta_kg, Variation_difference, Variation_kg)
  } else {
    summary_table <- summary_table %>%
      select(Month, Week, Sum_total_kg_Bruto, Cumulative_Sum_total_kg_Bruto, Cumulative_Sum_delta_kg, Variation_difference, Variation_kg)
  }
  
  summary_table
})


```

## Column

### 

```{r}
output$plot2 <- renderPlotly({
  x_var <- if (input$ID010 == "Days") "Date" else "Week_Start_Date"
  
  p <- ggplot(data_long(), aes_string(x = x_var, y = "Kg", fill = "Type", color = "Type", group = "Type")) +
    geom_area(position = "dodge", alpha = 0.5) +
    geom_point(size = 2, shape = 21, stroke = 1.5) +
    scale_fill_manual(values = c("total_kg_pagado" = "#048B9A", "total_kg_Bruto" = "#e73e01")) +
    scale_color_manual(values = c("total_kg_pagado" = "#048B9A", "total_kg_Bruto" = "#e73e01")) +
    scale_x_date(
      name = "Date",
      date_breaks = if (input$ID010 == "Days") "1 week" else "1 month",
      date_labels = if (input$ID010 == "Days") "%Y-%m-%d" else "%Y-%m (W%V)",
      expand = c(0, 0)
    ) +
    labs(
      title = "Graph of Kg Paid vs. Kg Received",
      x = "Date",
      y = "Kilograms",
      fill = "Type",
      color = "Type"
    ) +
    theme_minimal(base_family = "Palatino") +
    theme(
      plot.background = element_rect(fill = "white"),
      axis.text.x = element_text(angle = 45, hjust = 1, color = "#048B9A"),
      legend.position = "bottom",
      plot.title = element_text(size = 16, color = "#000000"),
      plot.title.position = "plot",
      axis.title = element_text(size = 10, color = "#000000"),
      axis.text = element_text(size = 10, color = "#000000")
    )
  
  ggplotly(p)
})

plotlyOutput("plot2")

```

## Column

### 

```{r}
# Fonction pour styliser les valeurs de Variation_difference
style_color <- function(value) {
  if (value > 0) {
    return(paste0('<span style="color:#76B041;">', value, '</span>'))
  } else if (value < 0) {
    return(paste0('<span style="color:#D9534F;">', value, '</span>'))
  } else {
    return(value)
  }
}

output$table2 <- renderDT({

  summary_table <- summary_table_dt()
  
  summary_table <- summary_table %>%
    mutate(
      Variation_difference = sapply(Variation_difference, style_color),
      Variation_kg = sapply(Variation_kg, style_color)
    )
  
  datatable(summary_table, 
            escape = FALSE, 
            options = list(dom = 't', paging = FALSE, searching = FALSE),
            class = "my-custom-table"
            )
})

DTOutput("table2")
```

# Ranking Producers {data-navmenu="Analysis of Producer Performance" data-navmenu-icon="fa-bookmark"}

## Sidebar {.sidebar}

```{r}
# ------------------- Sélecteur de Condition -------------------
# Radio buttons pour choisir la condition
radioGroupButtons(
  inputId = "ID011",
  label = "Condition :",
  choices = c("Baba" = "baba", "Seco" = "seco"),
  selected = "baba"
)

# ------------------- Sélecteur de Période -------------------
dateRangeInput(
  inputId = "ID012",
  label = "Sélectionner une période :",
  start = min(df_productores$Fecha),
  end = max(df_productores$Fecha),
  min = min(df_productores$Fecha),
  max = max(df_productores$Fecha),
  format = "dd/mm/yyyy",
  separator = " à "
)

# Réactive pour filtrer les producteurs
df_productores_filtered <- reactive({
  df <- df_productores %>% 
    filter(Condicion == input$ID011)
  
  if (!is.null(input$ID012)) {
    df <- df %>% 
      filter(Fecha >= input$ID012[1] & Fecha <= input$ID012[2])
  }
  df
})

# Calculer les différences par producteur
df_diff_prod <- reactive({
  df <-  df_productores_filtered() %>%
    group_by(Productor, Condicion) %>%
    summarise(
      delta_kg = sum(reparticion),
      nbr_kg_vendido = sum(Peso_pagado)
    ) %>%
    arrange(delta_kg) %>%
    mutate(pct = round(delta_kg / nbr_kg_vendido, 2))
  df
})

```

## Column

### 

```{r}
output$top_selling_producers <- renderPlotly({
  df <- df_diff_prod() %>%
    arrange(desc(nbr_kg_vendido)) %>%
    head(10)
  
  p <- ggplot(df, aes(x = reorder(Productor, nbr_kg_vendido), y = nbr_kg_vendido, fill = Condicion)) +
    geom_bar(stat = "identity") +
    coord_flip() +
    labs(
      title = "Top 10 Producteurs par Kilos Vendus",
      x = "Producteur",
      y = "Kilos Vendus (approximativement)",
      fill = "Condition"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 16, hjust = 0.5),
      axis.text.x = element_text(size = 10),
      axis.text.y = element_text(size = 10)
    )
  
  ggplotly(p)
})

plotlyOutput("top_selling_producers")
```

## Column {.tabset}

### en Kg

#### 

```{r}
output$top_diff_producers <- renderPlotly({
  df <- df_diff_prod() %>%
    arrange(desc(delta_kg)) %>%
    head(10)
  
  p <- ggplot(df, aes(x = reorder(Productor, delta_kg), y = delta_kg, fill = Condicion)) +
    geom_bar(stat = "identity") +
    coord_flip() +
    labs(
      title = "Top 10 Producteurs par Différence (Delta kg)",
      x = "Producteur",
      y = "Différence (Delta kg)",
      fill = "Condition"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 16, hjust = 0.5),
      axis.text.x = element_text(size = 10),
      axis.text.y = element_text(size = 10)
    )
  
  ggplotly(p)
})

div(class = "scrollable-plot", plotlyOutput("top_diff_producers"))

```

#### 

```{r}
output$bottom_diff_producers <- renderPlotly({
  df <- df_diff_prod() %>%
    arrange(delta_kg) %>%
    head(10)
  
  p <- ggplot(df, aes(x = reorder(Productor, delta_kg), y = delta_kg, fill = Condicion)) +
    geom_bar(stat = "identity") +
    coord_flip() +
    labs(
      title = "Pires 10 Producteurs par Différence (Delta kg)",
      x = "Producteur",
      y = "Différence (Delta kg)",
      fill = "Condition"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 16, hjust = 0.5),
      axis.text.x = element_text(size = 10),
      axis.text.y = element_text(size = 10)
    )
  
  ggplotly(p)
})

div(class = "scrollable-plot", plotlyOutput("bottom_diff_producers"))

```

### En %

#### 

```{r}
output$top_diff_producers_pct <- renderPlotly({
  df <- df_diff_prod() %>%
    arrange(desc(pct)) %>%
    head(10)
  
  p <- ggplot(df, aes(x = reorder(Productor, pct), y = pct, fill = Condicion)) +
    geom_bar(stat = "identity") +
    coord_flip() +
    labs(
      title = "Top 10 Producteurs par Différence (%)",
      x = "Producteur",
      y = "Différence (%)",
      fill = "Condition"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 16, hjust = 0.5),
      axis.text.x = element_text(size = 10),
      axis.text.y = element_text(size = 10)
    )
  
  ggplotly(p)
})


div(class = "scrollable-plot", plotlyOutput("top_diff_producers_pct"))


```

#### 

```{r}
output$bottom_diff_producers_pct <- renderPlotly({
  df <- df_diff_prod() %>%
    arrange(pct) %>%
    head(10)
  
  p <- ggplot(df, aes(x = reorder(Productor, pct), y = pct, fill = Condicion)) +
    geom_bar(stat = "identity") +
    coord_flip() +
    labs(
      title = "Pires 10 Producteurs par Différence (%)",
      x = "Producteur",
      y = "Différence (%)",
      fill = "Condition"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 16, hjust = 0.5),
      axis.text.x = element_text(size = 10),
      axis.text.y = element_text(size = 10)
    )
  
  ggplotly(p)
})

div(class = "scrollable-plot", plotlyOutput("bottom_diff_producers_pct"))

```

# Analyse producers {data-navmenu="Analysis of Producer Performance" data-orientation="rows"}

## Sidebar {.sidebar}

```{r}
# ------------------- Sélecteur de Condition -------------------
# Radio buttons pour choisir la condition
radioGroupButtons(
  inputId = "ID013",
  label = "Condition :",
  choices = c("Baba" = "baba", "Seco" = "seco"),
  selected = "baba"
)

# ------------------- Sélecteur de Période -------------------
dateRangeInput(
  inputId = "ID014",
  label = "Sélectionner une période :",
  start = min(df_productores$Fecha),
  end = max(df_productores$Fecha),
  min = min(df_productores$Fecha),
  max = max(df_productores$Fecha),
  format = "dd/mm/yyyy",
  separator = " à "
)

# Réactive pour filtrer les producteurs
df_productores_filtered2 <- reactive({
  df <- df_productores %>% 
    filter(Condicion == input$ID013)
  
  if (!is.null(input$ID014)) {
    df <- df %>% 
      filter(Fecha >= input$ID014[1] & Fecha <= input$ID014[2])
  }
  df
})

# ------------------- Sélecteur de Quartile -------------------
sliderInput(
  inputId = "ID015",
  label = "Select a Range Quartil",
  min = 0.1,
  max = 1,
  value = 0.3,
  step = 0.1
)
```

## Column {data-height="1300"}

### 

```{r}
output$boxplot2 <- renderPlotly({
  df_productores <- df_productores_filtered2()
  
  # Compter le nombre de données pour chaque producteur
  count_data <- df_productores %>%
    group_by(Productor) %>%
    summarise(count = n()) %>%
    arrange(desc(count))
  
  num_top_percent <- ceiling(nrow(count_data) * input$ID015)
  
  top_percent_productors <- count_data %>%
    top_n(num_top_percent, count) %>%
    pull(Productor)
  
  # Filtrer les données pour conserver uniquement les producteurs sélectionnés
  df_filtered <- df_productores %>%
    filter(Productor %in% top_percent_productors)
  
  

  fig <- plot_ly(
    data = df_filtered,
    y = ~reparticion,
    x = ~Productor,
    type = "box",
    color = ~Productor,  # Utiliser color pour les couleurs de remplissage
    colors = custom_colors,  # Appliquer la palette de couleurs
    quartilemethod = "linear",
    boxpoints = "all",
    jitter = 0.3,
    pointpos = -1.8,
    marker = list(
      outliercolor = "red",
      size = 5
    ),
    line = list(
      width = 0.5
    )
  ) %>%
    layout(
      title = list(
        text = paste("Distribution of the Difference in kg (Purchased vs. Delivered to the Factory) by Top", input$ID015*100,"% Productors"),
        x = 0.5
      ),
      xaxis = list(
        title = "Productors",
        tickangle = 45,
        tickfont = list(size = 10),
        titlefont = list(size = 12)
      ),
      yaxis = list(
        title = "Repartition",
        titlefont = list(size = 12)
      ),
      legend = list(
        title = list(text = "Productors"),
        font = list(size = 10)
      ),
      margin = list(t = 50)
    )
  
  fig
})

plotlyOutput("boxplot2", height = "90vh")

```

## Column

### 



# Who does he deal with the most ? {data-navmenu="Analysis of Producer Performance"}

## Sidebar {.sidebar data-width="350"}

```{r}
# ------------------- Sélecteur de Période -------------------
dateRangeInput(
  inputId = "ID016",
  label = "Sélectionner une période :",
  start = min(df_productores$Fecha),
  end = max(df_productores$Fecha),
  min = min(df_productores$Fecha),
  max = max(df_productores$Fecha),
  format = "dd/mm/yyyy",
  separator = " à "
)

unique_producers <- sort(unique(df_productores$Productor))

pickerInput(
  inputId = "ID017",
  label = "Choose Producers :",
  choices = unique_producers,
  selected = unique_producers[1],  # Sélectionne tous les acheteurs par défaut
  multiple = T,
  options = list(
    size = 10,
    `actions-box` = TRUE,  # Permet de sélectionner/désélectionner tout
    `selected-text-format` = "count > 3",  # Affiche un nombre si plus de 3 éléments sélectionnés
    `live-search` = TRUE  # Ajoute une fonction de recherche en direct
  )
)

df_producers_unique <- reactive({
  if (!is.null(input$ID016)) {
    df <- df_productores %>% 
      filter(Fecha >= input$ID016[1] & Fecha <= input$ID016[2])
  }
  df <- df %>%
    filter(Productor %in% input$ID017)
  df
})

```

## Column

```{r}
output$pie1 <- renderPlot({
  df <- df_producers_unique()
  df <- as.data.frame(table(df$Comprador))
  colnames(df) <- c("Comprador", "Count")
  df <- df %>%
    arrange(desc(Count)) %>%
    mutate(percentage = Count / sum(Count) * 100,  # Calcul des pourcentages
           label = paste0("(", round(percentage, 1), "%)"))  # Création des étiquettes avec pourcentages
  
  ggplot(df, aes(x = seq_along(Count), y = sqrt(Count), fill = Comprador)) +
    geom_col(width = 1, color = "grey10") +  # Couleur des bordures pour des segments clairs
    coord_radial("x", rotate.angle = T, expand = F) +
    
    # Ajouter les étiquettes avec les pourcentages en dehors des segments
    geom_text(aes(y = sqrt(Count) / 2 + 1.5,  # Position des étiquettes à l'extérieur des segments
                  label = label),
              size = 4, 
              color = "black", 
              fontface = "bold",
              hjust = 0,
              nudge_x = 0) +
    
    labs(title = "Distribution des Producteurs",
         fill = "Producteurs") +
    theme_void() +  # Supprime les éléments de thème inutiles
    theme(
      plot.title = element_text(size = 18, face = "bold", family = "Palatino Linotype"),
      legend.title = element_text(size = 12, family = "Palatino Linotype"),
      legend.text = element_text(size = 10, family = "Palatino Linotype"),
      panel.background = element_rect(fill = "#F9F9F9"),  # Couleur de fond du graphique
      plot.background = element_rect(fill = "#F9F9F9")  # Couleur de fond du graphique
    )
})

plotOutput("pie1")

```

# Who are the outsiders ?

```{css, echo=FALSE}
#navbar {
  font-family: "Palatino Linotype", "Book Antiqua", "Palatino", serif;
}

/* Style des boutons de groupe de cases à cocher */
.btn-check {
  display: none; /* Masquer les boutons de case à cocher par défaut */
}
.btn-group-toggle .btn {
  border-radius: 5px; /* Coins arrondis pour les boutons */
  border: 0.5px solid #772953; /* Bordure des boutons */
  background-color: #E1BBCB; /* Couleur de fond des boutons */
  color: #fff; /* Couleur du texte des boutons */
}
.btn-group-toggle .btn.active {
  background-color: #772953; /* Couleur de fond des boutons sélectionnés */
  color: #fff; /* Couleur du texte des boutons sélectionnés */
  border-color: #772953; /* Bordure des boutons sélectionnés */
}

.btn-group-toggle .btn:hover {
  background-color: #772953; /* Couleur de fond au survol des boutons */
  border-color: #E1BBCB; /* Bordure au survol des boutons */
}

/* Style pour le bouton du pickerInput */
.bootstrap-select .btn {
  background-color: #E1BBCB; /* Couleur de fond du bouton */
  color: #fff; /* Couleur du texte du bouton */
  border-radius: 5px; /* Coins arrondis */
  border: 1px solid #772953; /* Bordure du bouton */
  padding: 10px 20px; /* Padding interne du bouton */
}
.bootstrap-select .btn:hover {
  background-color: #772953; /* Couleur de fond au survol */
  border-color: #772953; /* Bordure au survol */
}
.bootstrap-select .dropdown-menu {
  border-radius: 5px; /* Coins arrondis du menu déroulant */
  box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); /* Ombre portée */
}
.bootstrap-select .btn:focus, .bootstrap-select .btn:active {
  background-color: #E1BBCB; /* Couleur de fond lors du focus ou clic */
  border-color: #E1BBCB; /* Bordure lors du focus ou clic */
}
.bootstrap-select .dropdown-menu .inner {
  padding: 0; /* Supprimer le padding interne */
}
.bootstrap-select .dropdown-menu .inner > li.selected > a {
  background-color: #772953; /* Couleur de fond de l'élément sélectionné */
  color: #fff; /* Couleur du texte de l'élément sélectionné */
}
.bootstrap-select .dropdown-menu .inner > li > a:hover {
  background-color: #E1BBCB; /* Couleur de fond au survol des éléments */
}

.value-box {
  border-radius: 10px;
  box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.3);
}
.info-box {
  border-radius: 10px;
  box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.3);
}
.my-custom-table {
  border-collapse: collapse;
}
.my-custom-table th, .my-custom-table td {
  border: 1px solid #ddd;
  padding: 8px;
}
.my-custom-table tr:nth-child(even) {
  background-color: #E1BBCB;
}
.my-custom-table tr:nth-child(odd) {
  background-color: #fff;
}
.my-custom-table th {
  background-color: #772953;
  color: white;
}

.custom-container {
  background-color: #8B0000; /* Couleur de fond */
  color: white; /* Couleur du texte */
  padding: 13px; /* Espacement interne */
  border-radius: 5px; /* Coins arrondis */
  display: flex; /* Utilise Flexbox pour le centrage */
  align-items: center; /* Centre verticalement */
  justify-content: center; /* Centre horizontalement */
  width: 100%; /* Remplir la largeur disponible */
  height: 100%; /* Remplir la hauteur disponible */
  text-align: center; /* Centre le texte */
}

.custom-container2 {
  background-color: #E6B336; /* Couleur de fond */
  padding: 13px; /* Espacement interne */
  border-radius: 5px; /* Coins arrondis */
  display: flex; /* Utilise Flexbox pour le centrage */
  align-items: center; /* Centre verticalement */
  justify-content: center; /* Centre horizontalement */
  width: 100%; /* Remplir la largeur disponible */
  height: 100%; /* Remplir la hauteur disponible */
  text-align: center; /* Centre le texte */
}

.scrollable-plot {
  height: 40vh; /* Ajustez cette hauteur selon vos besoins */
  overflow-y: auto;
}

.map {
  height: 75vh; /* 80% de la hauteur de la fenêtre du navigateur */
  width: 100%; /* Assure que la carte occupe toute la largeur disponible */
}

.fixed-height-box {
  height: 15vh; /* Ajustez cette hauteur selon vos besoins */
  display: flex;
  align-items: center;
  justify-content: center;
}

.leaflet-bottom.leaflet-left .legend {
  margin-bottom: 300px; /* Décale la légende vers le haut */
}

.leaflet-bottom.leaflet-right .legend {
  margin-bottom: 250px; /* Décale la légende vers le haut */
}

.form-control .btn {
  background-color: #772953; /* Couleur de fond */
  color: white; /* Couleur du texte */
  padding: 13px; /* Espacement interne */
  border-radius: 5px; /* Coins arrondis */
  display: flex; /* Utilise Flexbox pour le centrage */
  align-items: center; /* Centre verticalement */
  justify-content: center; /* Centre horizontalement */
  width: 100%; /* Remplir la largeur disponible */
  height: 100%; /* Remplir la hauteur disponible */
  text-align: center; /* Centre le texte */
}

.input-group-addon {
  background-color: #E1BBCB;
  color:white;
}

/* Changer la couleur de fond des éléments sélectionnés */
.selectize-control.single .selectize-input {
  background-color: #772953; /* Couleur de fond du champ de saisie */
  color: #F0F0F0; /* Couleur du texte */
}

/* Changer la couleur de fond du menu déroulant */
.selectize-control .selectize-dropdown {
  background-color: #F0F0F0; /* Couleur de fond du menu */
  color: #772953; /* Couleur du texte */
}

/* Changer la couleur de l'option déjà sélectionnée */
.selectize-control.single .selectize-dropdown .option.selected {
  background-color: #772953; /* Couleur de fond de l'option sélectionnée */
  color: #F0F0F0; /* Couleur du texte de l'option sélectionnée */
}

/* Changer la couleur de surbrillance des options dans le menu */
.selectize-control .selectize-dropdown .option:hover {
  background-color: #772953; /* Couleur de fond au survol */
  color: #F0F0F0; /* Couleur du texte au survol */
}

/* Style du label */
label {
  font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
  font-size: 16px;
  color: #772953; /* Couleur du texte de l'étiquette */
}


```
