---
title: "Bayacao Transport"
output: 
  flexdashboard::flex_dashboard:
    orientation: column
    vertical_layout: fill
    theme: united
runtime: shiny
---

```{r setup, include=FALSE}
# ------------------- Chargement des bibliothèques -------------------
pacman::p_load(
  knitr,
  leaflet,
  plotly,
  shiny,
  shinydashboard,
  readxl,
  flexdashboard,
  sf,
  dplyr,
  lubridate,
  tidyr,
  scales,
  DT,
  shinyWidgets,
  purrr,
  rio,
  here,
  geosphere
)

# ------------------- Lecture des Données Excel -------------------
# Utiliser here() pour définir le chemin vers le fichier Excel
file_path <- here("datasets","Las horas de laborales","Processed_Historial.xlsx")

# Lire toutes les feuilles du fichier Excel dans une liste
sheets <- excel_sheets(file_path)  # Obtenir les noms des feuilles

# Lire toutes les feuilles dans une liste
sheets_data <- lapply(sheets, function(sheet_name) {
  import(file_path, which = sheet_name)
})

names(sheets_data) <- sheets

# ------------------- Lecture des Données Additionnelles -------------------
# Utiliser here() pour définir le chemin vers les autres fichiers
df_compra <- import(here("datasets","Compra","compra_filtra.xlsx"))
df_productores <- import(here("datasets","Compra", "productores.xlsx"))

# ------------------- Décompression et Lecture du Fichier KMZ -------------------
# Décompresser et lire le fichier KMZ
unzip("INTERMEDIARIOS 1.kmz", exdir = here())
kml_file <- here("doc.kml")
df_kml <- st_read(kml_file)

# ------------------- Lecture des Fichiers Shapefile -------------------
# Lire le shapefile de la carte de la République Dominicaine (niveau administratif 1)
carte_Dom <- st_read(here("dom_shp", "dom_admbnda_adm1_one_20210629.shp"), options = "IGNORE_ERRORS=YES") %>%
  st_transform(crs = 4326)  # Transformer en CRS WGS 84

# Lire le shapefile de la carte de la République Dominicaine (niveau administratif 3)
carte_Dom2 <- st_read(here("dom_shp", "dom_admbnda_adm3_one_20210629.shp"), options = "IGNORE_ERRORS=YES") %>%
  st_transform(crs = 4326)  # Transformer en CRS WGS 84


```

# Mapa de lugares de los conductores{data-orientation=rows}

## Sidebar {.sidebar}

```{r}
# ------------------- Sélecteur de Feuille -------------------
# Utiliser selectizeInput pour choisir la feuille
selectizeInput(
  inputId = "ID001",
  label = "Choisissez la feuille:",
  choices = sheets,
  selected = sheets[1]
)

# ------------------- Données Réactives -------------------
# Créer une fonction réactive pour obtenir les données de la feuille sélectionnée
df_hora_trabajadas <- reactive({
  sheet_name <- input$ID001
  if (is.null(sheet_name) || !(sheet_name %in% names(sheets_data))) {
    return(NULL)  # Retourner NULL si la feuille n'est pas valide
  }
  sheets_data[[sheet_name]]
})

# ------------------- Sélecteurs de Dates -------------------
# Utiliser dateRangeInput pour sélectionner une période
dateRangeInput(
  inputId = "ID002",
  label = "Sélectionner la période:",
  start = Sys.Date() - 2,  # Valeur par défaut, ajuster selon vos besoins
  end = Sys.Date() - 1,
  startview = "month",
  language = "es",
  separator = " à ",
  format = "dd/mm/yyyy"
)

# ------------------- Mise à Jour des Inputs de Date -------------------
# Observer les changements dans les données et mettre à jour les inputs de date
observe({
  data <- df_hora_trabajadas()
  if (is.null(data)) return()  # Ne rien faire si les données sont NULL
  
  # Mettre à jour les inputs de date avec les valeurs min et max des données
  updateDateRangeInput(session, "ID002",
                       min = min(data$Tiempo, na.rm = TRUE),
                       max = max(data$Tiempo, na.rm = TRUE))
})

```

## Mapa de la Republica Dominica

```{r}
# Fonction pour calculer les distances entre les points
calculate_distances <- function(data) {
  coords <- data %>% select(longitude, latitude)
  dists <- distHaversine(coords[-nrow(coords), ], coords[-1, ])
  return(dists)
}

# Fonction pour segmenter les routes
segment_routes <- function(data, threshold) {
  dists <- calculate_distances(data)
  segments <- cumsum(c(0, dists > threshold))
  data$segment <- segments
  return(data)
}

output$map1 <- renderLeaflet({
  
  data <- df_hora_trabajadas()
  if (is.null(data)) {
    return(NULL)
  }
  
  date_range <- input$ID002
  if (is.null(date_range) || length(date_range) != 2) {
    return(data)
  }
  
  start_date <- as.Date(date_range[1])
  end_date <- as.Date(date_range[2])

  if (is.null(data)) return(NULL)
  threshold_distance <- 3000  # Seuil de distance en mètres pour segmenter les routes
  df_filtered <- data %>%
      filter(!is.na(longitude), !is.na(latitude)) %>%  # Supprimer les points NA
      filter(longitude != 0, latitude != 0) %>%        # Supprimer les points aberrants
      segment_routes(threshold_distance)
  
  # Filtrer les points d'arrêt
  stops <- df_filtered %>%
    filter(is_stop == TRUE) %>%
    group_by(group) %>%
    summarise(latitude = first(latitude),
              longitude = first(longitude),
              label = first(local_name))
  
  df_filtered_today <- df_filtered %>%
    filter(Tiempo >= start_date & Tiempo <= end_date)

  if (!is.null(df_filtered) && nrow(df_filtered) > 0) {

    mymap <- leaflet() %>%
      addTiles()
      
    for (segment_id in unique(df_filtered$segment)) {
      segment_data <- df_filtered %>% filter(segment == segment_id)
      mymap <- mymap %>%
        addPolylines(
          data = segment_data,
          lng = ~longitude,
          lat = ~latitude,
          color = "blue"
        ) 
    }

    mymap <- mymap %>%
      addPolygons(data = carte_Dom, color = "black", weight = 1, fillOpacity = 0.2) %>%
      addCircleMarkers(data = stops,
                      color = "orange",
                      lng = ~longitude,
                      lat = ~latitude,
                      radius = 6,
                      label = ~paste(label)) %>%
      addMarkers(data = df_kml,
                 icon = icons(
                   iconUrl = "https://cdn-icons-png.flaticon.com/512/684/684908.png",
                   iconWidth = 15, iconHeight = 15,
                   iconAnchorX = 15, iconAnchorY = 30
                 ),
                 label = ~paste(Name),
                 group = "Producers")
    
    # Calculer le centre géographique du segment rouge pour centrer la carte
    red_segment_data <- df_filtered %>% filter(segment == unique(df_filtered$segment)[1])  # Prenez le premier segment rouge pour l'exemple
    center_lon <- mean(red_segment_data$longitude, na.rm = TRUE)
    center_lat <- mean(red_segment_data$latitude, na.rm = TRUE)
    
    # Définir la vue initiale pour centrer sur le segment rouge
    mymap <- mymap %>%
      setView(lng = center_lon, lat = center_lat, zoom = 10)
    
    # Ajouter les marqueurs de vitesse pour les segments verts
    mymap <- mymap %>%
      addCircleMarkers(
        data = df_filtered_today,
        lng = ~longitude,
        lat = ~latitude,
        color = ~colorNumeric(palette = "YlOrRd", domain = df_filtered_today$speed)(speed),
        radius = ~sqrt(speed) / 4,  # Taille des marqueurs en fonction de la vitesse
        popup = ~paste("Vitesse:", speed, "km/h"),
        fillOpacity = 0.7
      ) %>%
      addLegend(
        position = "bottomright",
        pal = colorNumeric(palette = "YlOrRd", domain = df_filtered_today$speed),
        values = df_filtered_today$speed,
        title = "Vitesse (km/h)",
        opacity = 1
      )
    
    # Afficher la carte
    mymap
  } else {
    leaflet() %>%
      addTiles() %>%
      addPolygons(data = carte_Dom, color = "black", weight = 1, fillOpacity = 0.2)
  }
})

leafletOutput("map1", height="80vh")

```

## Données Clés

### La distance parcourue en km sur les 30 derniers jours (route bleue)
```{r}
output$valueBox6 <- renderValueBox({
    data <- df_hora_trabajadas()
    valueBox(
      value =sum(data$distance),
    color = "#8B0000"
  )
})

valueBoxOutput("valueBox6")
```

### La distance parcourue cette journée  
```{r}
output$valueBox7 <- renderValueBox({
    data <- df_hora_trabajadas()
    start_date <- as.Date(input$ID002[1])
    end_date <- as.Date(input$ID002[2])
    data <- data %>%
      filter(Tiempo >= start_date & Tiempo <= end_date)
    
    valueBox(
      value =sum(data$distance),
    color = "#E6B336"
  )
})

valueBoxOutput("valueBox7")
```

### Le temps passé en circulant cette journée 
```{r}
output$valueBox8 <- renderValueBox({
  data <- df_hora_trabajadas()
  data <- data %>%
    filter(is_stop == F)
  
  total_seconds <- sum(data$time_diff)
  
  # Convertir en période
  period <- seconds_to_period(total_seconds)
  
  # Extraire les jours, heures, minutes et secondes
  days <- floor(total_seconds / (24 * 3600))
  hours <- hour(period)
  minutes <- minute(period)
  seconds <- second(period)
  
  # Formater la chaîne
  value <- sprintf("%d jours %02d:%02d:%02d", days, hours, minutes, seconds)
  
  valueBox(
    value = value,
    color = "#8B0000"
  )
})

valueBoxOutput("valueBox8")
```

# Para una dia {data-navmenu="Variacion de compra" data-navmenu-icon="fa-bookmark"}

## Sidebar {.sidebar}

```{r}
# ------------------- Sélecteur de Date -------------------
# Utiliser dateRangeInput pour sélectionner un intervalle de dates
dateRangeInput(
  inputId = "ID003",
  label = "Seleccionar rango de fechas:",
  start = max(df_compra$Fecha, na.rm = TRUE) - days(7),
  end = max(df_compra$Fecha, na.rm = TRUE),
  min = min(df_compra$Fecha, na.rm = TRUE),
  max = max(df_compra$Fecha, na.rm = TRUE),
  format = "yyyy-mm-dd",
  startview = "month",
  language = "es",
  separator = " a "
)

# ------------------- Sélecteur de Condition -------------------
# Utiliser checkboxGroupButtons pour sélectionner les conditions
checkboxGroupButtons(
  inputId = "ID004",
  label = "Condicion:",
  choices = c("Baba" = "baba", "Seco" = "seco", "Fermentado" = "fermentado"),
  selected = c("baba"),
  direction = "vertical"
)

# ------------------- Filtrage des Données -------------------
# Fonction réactive pour filtrer les données en fonction de la période et des conditions
filtered_df <- reactive({
  start_date <- as.Date(input$ID003[1], format = "%Y-%m-%d")
  end_date <- as.Date(input$ID003[2], format = "%Y-%m-%d")
  
  df_compra %>%
    filter(Fecha >= start_date & Fecha <= end_date & Condicion %in% input$ID004)
})

# ------------------- Agrégation des Données -------------------
# Fonction réactive pour agréger les données filtrées
df_filtered <- reactive({
  filtered_df() %>%
    group_by(Comprador, Condicion) %>%
    summarise(
      total_kg_pagado = sum(total_kg_pagado, na.rm = TRUE),
      total_kg_Bruto = sum(total_kg_Bruto, na.rm = TRUE)
    ) %>%
    pivot_longer(cols = c(total_kg_pagado, total_kg_Bruto),
                 names_to = "Type",
                 values_to = "kg") %>%
    mutate(Type = factor(Type, levels = c("total_kg_pagado", "total_kg_Bruto"), labels = c("Acheté", "Transmis à la factory")))
})

# ------------------- Calcul des Variations -------------------
# Fonction réactive pour calculer les variations des données filtrées
variations_df <- reactive({
  filtered_df() %>%
    group_by(Comprador, Condicion) %>%
    summarise(
      total_kg_pagado = sum(total_kg_pagado, na.rm = TRUE),
      total_kg_Bruto = sum(total_kg_Bruto, na.rm = TRUE)
    ) %>%
    mutate(proporcion_delta = (total_kg_Bruto - total_kg_pagado) / total_kg_pagado * 100) %>%
    select(Comprador, Condicion, proporcion_delta)
})

# ------------------- Filtrage et Agrégation Supplémentaires -------------------
# Fonction réactive pour filtrer et agréger les données avec delta
variations2_df <- reactive({
  filtered_df() %>%
    group_by(Comprador, Condicion) %>%
    summarise(delta_kg = sum(delta_kg, na.rm = TRUE)) %>%
    ungroup() %>%
    group_by(Comprador) %>%
    summarise(total_delta_kg = sum(delta_kg, na.rm = TRUE)) %>%
    ungroup() %>%
    arrange(desc(total_delta_kg))
})

```

## Acheteurs {data-width=550}

### BarPlot

```{r}
output$barplot1 <- renderPlot({

  ggplot(df_filtered(), aes(x = Comprador, y = kg, fill = Type, group = Type)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.8) +
    geom_line(aes(group = Comprador), position = position_dodge(0.4)) +
    geom_text(aes(label = scales::comma(kg)),
              position = position_dodge(width = 0.8),
              vjust = -0.5,
              size = 3) +
    labs(
      title = "Nombre de kg achetés vs. transmis à la factory",
      x = "Acheteur",
      y = "Nombre de Kg",
      fill = "Type de Kg"
    ) +
    theme_minimal(base_size = 15) +
    theme(
      plot.title = element_text(hjust = 0.5),
      axis.title.x = element_text(margin = margin(t = 10)),
      axis.title.y = element_text(margin = margin(r = 10)),
      axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
      strip.background = element_rect(fill = "lightgrey", color = "black"),
      strip.text = element_text(size = 14, face = "bold")
    ) +
    facet_wrap(~ Condicion, scales = "free_y")
},width = "auto")

plotOutput("barplot1", height = "50vh")

```

## Ranking {data-width=450} 

### Ranking Plot
```{r}
output$rankingPlot1 <- renderPlot({
  ggplot(variations_df(), aes(x = reorder(Comprador, -proporcion_delta), y = proporcion_delta, fill = proporcion_delta)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = paste0(round(proporcion_delta, 2), "%")), vjust = -0.5, size = 3) +
    labs(
      title = "Classement des acheteurs par variation proportionnelle",
      x = "Acheteur",
      y = "Variation (%)",
      fill = "Variation (%)"
    ) +
    scale_fill_gradient2(
      low = "#e73e01",   # Couleur pour les valeurs négatives

      high = "#048B9A",  # Couleur pour les valeurs positives
      midpoint = 0       # Point de transition entre les deux couleurs
    ) +
    theme_minimal(base_size = 15) +
    theme(
      plot.title = element_text(hjust = 0.5),
      axis.title.x = element_text(margin = margin(t = 10)),
      axis.title.y = element_text(margin = margin(r = 10)),
      axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
      strip.background = element_rect(fill = "lightgrey", color = "black"),
      strip.text = element_text(size = 14, face = "bold")
    )
}, width = "auto")

plotOutput("rankingPlot1", height = "50vh")

```

### Ranking Plot2 
```{r}
output$rankingPlot2 <- renderPlot({
  ggplot(variations2_df(), aes(x = reorder(Comprador, -total_delta_kg), y = total_delta_kg, fill = total_delta_kg)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = paste0(round(total_delta_kg, 2), " kg")),
              vjust = -0.5,
              size = 3) +
    labs(
      title = "Classement des acheteurs par somme des variations en kg",
      x = "Acheteur",
      y = "Variation totale (kg)",
      fill = "Variation totale (kg)"
    ) +
    scale_fill_gradient2(
      low = "#e73e01",   # Couleur pour les valeurs négatives

      high = "#048B9A",  # Couleur pour les valeurs positives
      midpoint = 0       # Point de transition entre les deux couleurs
    ) +
    theme_minimal(base_size = 15) +
    theme(
      plot.title = element_text(hjust = 0.5),
      axis.title.x = element_text(margin = margin(t = 10)),
      axis.title.y = element_text(margin = margin(r = 10)),
      axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
      strip.background = element_rect(fill = "lightgrey", color = "black"),
      strip.text = element_text(size = 14, face = "bold")
    )
}, width = "auto")

plotOutput("rankingPlot2", height = "50vh")


```

# Llave de datos {data-navmenu="Variacion de compra" data-orientation=rows}

## Sidebar {.sidebar}
```{r}

radioGroupButtons("ID005",
                 "Condicion:",
                 c("Baba" = "baba",
                   "Seco" = "seco",
                   "Fermentado" = "fermentado"),
                 selected = c("baba")
)

# Liste des acheteurs uniques
unique_compradores <- sort(unique(df_compra$Comprador))

# Créer une liste d'options pour le selectInput
options_compradores <- c("Seleccionar todo", unique_compradores)

pickerInput(
  inputId = "ID006",
  label = "Elija uno o todos compradores:",
  choices = options_compradores,
  selected = "Seleccionar todo",
  multiple = TRUE,
  options = list(
    `actions-box` = TRUE,  # Permet de sélectionner/désélectionner tout
    `selected-text-format` = "count > 3",  # Affiche un nombre si plus de 3 éléments sélectionnés
    `live-search` = TRUE  # Ajoute une fonction de recherche en direct
  )
)

df_compra_filtered <- reactive({
  # Vérifie si "Seleccionar todo" est sélectionné
  if ("Seleccionar todo" %in% input$ID006) {
    df_compra %>% filter(Condicion == input$ID005)
  } else {
    # Sinon, filtre par acheteurs sélectionnés
    df_compra %>% filter(Comprador %in% input$ID006 & Condicion == input$ID005)
  }
})


```

## Column

### BoxPlot
```{r}
# Ajouter un graphique plotly pour voir les faltas selon les compradores et les conditions
output$boxplot1 <- renderPlotly({
  df_compra_filter <- df_compra_filtered()
  
  fig <- plot_ly(
    data = df_compra_filter,
    y = ~delta_kg,
    x = ~Comprador,
    type = "box",
    color = ~Comprador,  # Utiliser color pour les couleurs de remplissage
    quartilemethod = "linear",
    boxpoints = "all",
    jitter = 0.3,
    pointpos = -1.8,
    marker = list(
      outliercolor = "red",
      size = 5
    ),
    line = list(
      width = 0.5
    )
  ) %>%
    layout(
      title = list(
        text = "Distribution de la différence de kg (acheté et rentré à l'usine) par Acheteur",
        x = 0.5
      ),
      xaxis = list(
        title = "Acheteur",
        tickangle = 45,
        tickfont = list(size = 10),
        titlefont = list(size = 12)
      ),
      yaxis = list(
        title = "Delta Kg",
        titlefont = list(size = 12)
      ),
      legend = list(
        title = list(text = "Acheteur"),
        font = list(size = 10)
      ),
      margin = list(t = 50)
    )
  
  fig
})

plotlyOutput("boxplot1", height = "50vh")

```

## Column 

### Le prix au kilo d'un sac acheté en moyenne
```{r}
output$valueBox1 <- renderValueBox({
  df_compra_filter <- df_compra_filtered()
  valueBox(
    value = dollar(mean(df_compra_filter$total_kg_Bruto/df_compra_filter$cantidad_saco)),
    color = "#E6B336"
  )
})



valueBoxOutput("valueBox1")
```

### Nombre d'achats par jours et par acheteurs
```{r}
output$valueBox2 <- renderValueBox({
    df_compra_filter <- df_compra_filtered()
    valueBox(
      value = nrow(df_compra_filter),
    color = "#8B0000"
  )
})

valueBoxOutput("valueBox2", width = 6)
```

### Total des Écarts de Poids entre Achat et Réception à l'Usine
```{r}
output$valueBox3 <- renderValueBox({
  df_compra_filter <- df_compra_filtered()
  valueBox(
    value = paste(sum(df_compra_filter$delta_kg)," KG"),
    color = "#E6B336"
  )
})

valueBoxOutput("valueBox3")
```


### Moyenne des Variations de Poids
```{r}
output$valueBox4 <- renderValueBox({
  df_compra_filter <- df_compra_filtered()
  somme_poids <- sum(df_compra_filter$total_kg_pagado, na.rm =T)
  moyenne_ponderee <- sum(df_compra_filter$delta_kg * df_compra_filter$total_kg_pagado)/somme_poids
  valueBox(
    value = paste(round(moyenne_ponderee ,2)," KG"),
    color = "#8B0000"
  )
})

valueBoxOutput("valueBox4")
```

### Nombre de KG acheté (Brut arrivé à l'usine)
```{r}
output$valueBox5 <- renderValueBox({
  df_compra_filter <- df_compra_filtered()
  valueBox(
    value = paste(round(sum(df_compra_filter$total_kg_Bruto))," KG"),
    color = "#E6B336"
  )
})

valueBoxOutput("valueBox5")
```

# Compradores {data-navmenu="Variacion de compra" data-orientation=rows}

## Sidebar {.sidebar}

```{r}
radioGroupButtons("ID007",
                 "Condicion:",
                 c("Baba" = "baba",
                   "Seco" = "seco",
                   "Fermentado" = "fermentado"),
                 selected = c("baba")
)

# Liste des acheteurs uniques
unique_compradores <- sort(unique(df_compra$Comprador))

# Créer une liste d'options pour le selectInput
options_compradores <- c("Seleccionar todo", unique_compradores)

pickerInput(
  inputId = "ID008",
  label = "Elija uno o todos compradores:",
  choices = options_compradores,
  selected = "Seleccionar todo",
  multiple = TRUE,
  options = list(
    `actions-box` = TRUE,  # Permet de sélectionner/désélectionner tout
    `selected-text-format` = "count > 3",  # Affiche un nombre si plus de 3 éléments sélectionnés
    `live-search` = TRUE  # Ajoute une fonction de recherche en direct
  )
)

df_compra_filtered2 <- reactive({
  # Vérifie si "Seleccionar todo" est sélectionné
  if ("Seleccionar todo" %in% input$ID008) {
    df_compra %>% filter(Condicion == input$ID007)
  } else {
    # Sinon, filtre par acheteurs sélectionnés
    df_compra %>% filter(Comprador %in% input$ID008 & Condicion == input$ID007)
  }
})

df_productores_filtered <- reactive({
  # Vérifie si "Seleccionar todo" est sélectionné
  if ("Seleccionar todo" %in% input$ID008) {
    df_productores %>% filter(Condicion == input$ID007)
  } else {
    # Sinon, filtre par acheteurs sélectionnés
    df_productores %>% filter(Comprador %in% input$ID008 & Condicion == input$ID007)
  }
})

data_long <- reactive({
  df_compra_filtered2() %>%
    pivot_longer(cols = c("total_kg_pagado", "total_kg_Bruto"), names_to = "Type", values_to = "Kg") %>%
    mutate(
      Month_Year = format(as.Date(Fecha, format = "%Y-%m-%d"), "%Y-%m"),
      Week = format(as.Date(Fecha, format = "%Y-%m-%d"), "%Y-%U"),
      Week_Start_Date = as.Date(paste0(Week, "-1"), "%Y-%U-%u")
    ) %>%
    group_by(Week, Week_Start_Date, Type) %>%
    summarise(Kg = sum(Kg), .groups = 'drop', Month_Year = first(Month_Year))
})

summary_table_dt <- reactive({
  # Obtenir les données filtrées
  df_filtered <- df_compra_filtered2()
  
  # Ajouter les colonnes pour le mois et le numéro de la semaine
  df_filtered <- df_filtered %>%
    mutate(
      Month = format(Fecha, "%B"),
      Month = factor(Month, levels = month.name),  # Utiliser les niveaux de mois pour le tri correct
      Week = isoweek(Fecha)
    )
  
  # Grouper les données par mois et semaine et calculer les sommes totales par catégorie
  total_sums <- df_filtered %>%
    group_by(Week) %>%
    summarise(
      Sum_total_kg_Bruto = sum(total_kg_Bruto, na.rm = TRUE),
      Sum_delta_kg = sum(delta_kg, na.rm = TRUE),
      Month = first(Month),
      .groups = 'drop'
    ) %>%
    arrange(desc(Week))
  
  # Calculer les sommes cumulées
  summary_table <- total_sums %>%
    arrange(Week) %>%
    mutate(
      Cumulative_Sum_total_kg_Bruto = cumsum(Sum_total_kg_Bruto),
      Cumulative_Sum_delta_kg = cumsum(Sum_delta_kg),
      Variation_difference = (Cumulative_Sum_delta_kg - lag(Cumulative_Sum_delta_kg)) / abs(lag(Cumulative_Sum_delta_kg)) * 100,
      Variation_kg = Cumulative_Sum_delta_kg - lag(Cumulative_Sum_delta_kg)
    ) %>%
    arrange(desc(Week)) %>%
    mutate(
      Cumulative_Sum_total_kg_Bruto = replace_na(Cumulative_Sum_total_kg_Bruto, 0),
      Cumulative_Sum_delta_kg = replace_na(Cumulative_Sum_delta_kg, 0),
      Variation_difference = replace_na(Variation_difference, 0),
      Variation_kg = replace_na(Variation_kg, 0)
    ) %>%
    mutate(
      Cumulative_Sum_total_kg_Bruto = paste0(Cumulative_Sum_total_kg_Bruto, " kg"),
      Cumulative_Sum_delta_kg = paste0(Cumulative_Sum_delta_kg, " kg"),
      Variation_difference = paste0(round(Variation_difference, 2), " %"),
      Variation_kg = paste0(round(Variation_kg, 2), " kg")
    ) %>%
    select(
      Month, Week, Sum_total_kg_Bruto, Cumulative_Sum_total_kg_Bruto, Cumulative_Sum_delta_kg, Variation_difference, Variation_kg
    )
  
  summary_table
})
```

## Column 

### 
```{r}
output$plot2 <- renderPlotly({
  p <- ggplot(data_long(), aes(x = Week_Start_Date, y = Kg, fill = Type, color = Type, group = Type)) +
    geom_area(position = "dodge", alpha = 0.5) +
    geom_point(size = 2, shape = 21, stroke = 1.5) +
    scale_fill_manual(values = c("total_kg_pagado" = "#E1BBCB", "total_kg_Bruto" = "#772953")) +
    scale_color_manual(values = c("total_kg_pagado" = "#E1BBCB", "total_kg_Bruto" = "#772953")) +
    scale_x_date(
      name = "Date",
      date_breaks = "1 month",
      date_labels = "%Y-%m (W%V)", # %V is the ISO week number
      minor_breaks = "1 week",
      expand = c(0, 0)
    ) +
    labs(
      title = "Graphique des Kg Payés et Kg Entrés",
      x = "Date",
      y = "Kilogrammes",
      fill = "Type",
      color = "Type"
    ) +
    theme_minimal(base_family = "Arial") +
    theme(
      plot.background = element_rect(fill = "white"),
      axis.text.x = element_text(angle = 45, hjust = 1, color = "#772953"),
      legend.position = "bottom",
      plot.title = element_text(size = 12, face = "bold", color = "#772953"),
      axis.title = element_text(size = 10, color = "#772953"),
      axis.text = element_text(size = 10, color = "#772953"),
      panel.grid.minor = element_blank(),
      panel.grid.major = element_line(color = "#E1BBCB", size = 0.5)
    )
  ggplotly(p)
})



plotlyOutput("plot2", width = "90vh")


```

## Column

###  
```{r}
# Fonction pour styliser les valeurs de Variation_difference
style_color <- function(value) {
  if (value > 0) {
    return(paste0('<span style="color:#76B041;">', value, '</span>'))
  } else if (value < 0) {
    return(paste0('<span style="color:#D9534F;">', value, '</span>'))
  } else {
    return(value)
  }
}

output$table2 <- renderDT({

  summary_table <- summary_table_dt()
  
  summary_table <- summary_table %>%
    mutate(
      Variation_difference = sapply(Variation_difference, style_color),
      Variation_kg = sapply(Variation_kg, style_color)
    )
  
  datatable(summary_table, 
            escape = FALSE, 
            options = list(dom = 't', paging = FALSE, searching = FALSE),
            class = "my-custom-table"
            )
})

DTOutput("table2")
```

# Productores

## Sidebar {.sidebar}

## Column 

### 
```{r}
output$table_productores <- renderDT({
  data_long2 <- df_productores_filtered() %>%
    group_by(Productor) %>%
    summarise(total = n(), .groups = 'drop') %>%
    arrange(desc(total)) %>%
    top_n(10, wt = total)  # Conserver uniquement les 10 premiers producteurs

  datatable(
    data_long2,
    options = list(
      pageLength = 10,
      autoWidth = TRUE,
      order = list(list(2, 'desc')),  # Trier par colonne 'total' en ordre décroissant
      dom = 't'  # Pour ne montrer que le tableau sans pagination
    ),
    colnames = c("Producteur", "Nombre de Contributions"),
    caption = htmltools::tags$caption(
      style = 'caption-side: top; text-align: center; font-size: 16px; font-weight: bold;',
      "Classement des 10 Plus Gros Producteurs"
    )
  )
}, server = FALSE)

DTOutput("table_productores")
```

###
```{r}

output$map2 <- renderLeaflet({
  data_long3 <- df_productores_filtered()
  data_long3$Location <- paste0("Municipio ", data_long3$Location)
  
  df_municipalidad <- as.data.frame(table(data_long3$Location))
  
  colnames(df_municipalidad) <- c("Location", "Count")
  
  df_municipalidad <- df_municipalidad %>%
    group_by(Location) %>%
    summarise(Count = sum(Count), .groups = 'drop')
  
  df_dom_merge <- carte_Dom2 %>%
    merge(df_municipalidad, by.x = "ADM3_ES", by.y = "Location", all.x = TRUE)
  
  pal <- colorBin("YlOrRd", domain = df_dom_merge$Count, bins = 5, na.color = "transparent")
  
  leaflet(df_dom_merge) %>%
    addTiles() %>%
    addPolygons(
      fillColor = ~pal(Count),
      fillOpacity = 0.7,
      color = "black",
      weight = 1,
      popup = ~paste(ADM3_ES, "<br>", "Count: ", Count)
    ) %>%
    addLegend(
      position = "bottomright",
      pal = pal,
      values = ~Count,
      title = "Occurrences",
      opacity = 1,
      labFormat = labelFormat(suffix = " occurrences")
    )
})

leafletOutput("map2", height = "50vh")

```

# Datos del tablero

## Datos {.tabset}

### Horas Trabajado
```{r}
output$horasTrabajadas <- renderDT({
  DT::datatable(
    df_hora_trabajadas(),
    rownames = FALSE, 
    filter = "top"
  )
})

DTOutput("horasTrabajadas")
```

### Compra
```{r}
output$dataCompra <- renderDT({
  DT::datatable(
    df_compra,
    rownames = FALSE, 
    filter = "top"
  )
})

DTOutput("dataCompra")
```

```{css, echo=FALSE}

/* Style des boutons de groupe de cases à cocher */
.btn-check {
  display: none; /* Masquer les boutons de case à cocher par défaut */
}
.btn-group-toggle .btn {
  border-radius: 5px; /* Coins arrondis pour les boutons */
  border: 0.5px solid #772953; /* Bordure des boutons */
  background-color: #E1BBCB; /* Couleur de fond des boutons */
  color: #fff; /* Couleur du texte des boutons */
}
.btn-group-toggle .btn.active {
  background-color: #772953; /* Couleur de fond des boutons sélectionnés */
  color: #fff; /* Couleur du texte des boutons sélectionnés */
  border-color: #772953; /* Bordure des boutons sélectionnés */
}

.btn-group-toggle .btn:hover {
  background-color: #772953; /* Couleur de fond au survol des boutons */
  border-color: #E1BBCB; /* Bordure au survol des boutons */
}

/* Style pour le bouton du pickerInput */
.bootstrap-select .btn {
  background-color: #E1BBCB; /* Couleur de fond du bouton */
  color: #fff; /* Couleur du texte du bouton */
  border-radius: 5px; /* Coins arrondis */
  border: 1px solid #772953; /* Bordure du bouton */
  padding: 10px 20px; /* Padding interne du bouton */
}
.bootstrap-select .btn:hover {
  background-color: #772953; /* Couleur de fond au survol */
  border-color: #772953; /* Bordure au survol */
}
.bootstrap-select .dropdown-menu {
  border-radius: 5px; /* Coins arrondis du menu déroulant */
  box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); /* Ombre portée */
}
.bootstrap-select .btn:focus, .bootstrap-select .btn:active {
  background-color: #E1BBCB; /* Couleur de fond lors du focus ou clic */
  border-color: #E1BBCB; /* Bordure lors du focus ou clic */
}
.bootstrap-select .dropdown-menu .inner {
  padding: 0; /* Supprimer le padding interne */
}
.bootstrap-select .dropdown-menu .inner > li.selected > a {
  background-color: #772953; /* Couleur de fond de l'élément sélectionné */
  color: #fff; /* Couleur du texte de l'élément sélectionné */
}
.bootstrap-select .dropdown-menu .inner > li > a:hover {
  background-color: #E1BBCB; /* Couleur de fond au survol des éléments */
}

.value-box {
  border-radius: 10px;
  box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.3);
}
.info-box {
  border-radius: 10px;
  box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.3);
}
.my-custom-table {
  border-collapse: collapse;
}
.my-custom-table th, .my-custom-table td {
  border: 1px solid #ddd;
  padding: 8px;
}
.my-custom-table tr:nth-child(even) {
  background-color: #E1BBCB;
}
.my-custom-table tr:nth-child(odd) {
  background-color: #fff;
}
.my-custom-table th {
  background-color: #772953;
  color: white;
}

```
